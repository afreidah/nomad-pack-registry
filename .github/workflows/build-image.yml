# -------------------------------------------------------------------------------
# Project: Munchbox
# Author: Alex Freidah
# -------------------------------------------------------------------------------
# GitHub Actions workflow to build and push nomad-pack-builder Docker image to
# private registry. Runs on self-hosted runners only.
# -------------------------------------------------------------------------------

name: Build & Push Image

on:
  push:
    branches: [main]
    paths:
      - 'Dockerfile'
      - '.github/workflows/build-image.yml'
  workflow_dispatch:

jobs:
  # -----------------------------------------------------------------------
  # Build and push nomad-pack-builder image to private registry
  # -----------------------------------------------------------------------
  build:
    runs-on: [self-hosted, ci, github-actions]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set image metadata
        id: meta
        run: |
          REGISTRY="docker-mirror.service.consul"
          IMAGE_NAME="nomad-pack-builder"
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          
          echo "registry=${REGISTRY}" >> $GITHUB_OUTPUT
          echo "image_name=${IMAGE_NAME}" >> $GITHUB_OUTPUT
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "image_latest=${REGISTRY}/${IMAGE_NAME}:latest" >> $GITHUB_OUTPUT
          echo "image_sha=${REGISTRY}/${IMAGE_NAME}:${SHORT_SHA}" >> $GITHUB_OUTPUT

      - name: Build Docker image
        run: |
          docker build \
            --tag ${{ steps.meta.outputs.image_latest }} \
            --tag ${{ steps.meta.outputs.image_sha }} \
            .

      - name: Push to private registry
        run: |
          docker push ${{ steps.meta.outputs.image_latest }}
          docker push ${{ steps.meta.outputs.image_sha }}

      - name: Log image details
        run: |
          echo "âœ“ Image built and pushed successfully"
          echo "  Latest: ${{ steps.meta.outputs.image_latest }}"
          echo "  SHA:    ${{ steps.meta.outputs.image_sha }}"
