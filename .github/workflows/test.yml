# -------------------------------------------------------------------------------
# Project: Nomad Job Template
# Author: Alex Freidah
# -------------------------------------------------------------------------------
# GitHub Actions workflow to run nomad-pack template tests using containerized
# builder image from private registry on self-hosted runners.
# -------------------------------------------------------------------------------

name: Nomad Pack Tests

on:
  pull_request:
  push:
    branches: [main]
    tags: ['*']

jobs:
  # -----------------------------------------------------------------------
  # Test nomad-pack templates using container from private registry
  # -----------------------------------------------------------------------
  test:
    runs-on: [self-hosted, linux]
    container:
      image: docker-mirror.service.consul/nomad-pack-builder:latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Format check
        run: make fmt-check

      - name: Validate pack structure
        run: make validate

      - name: Security scanning
        run: make security

      - name: Render templates
        run: make render

      - name: Upload rendered jobs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rendered-nomad-jobs
          path: /tmp/nomad-pack-rendered/
          retention-days: 30

      - name: Test summary
        if: success()
        run: |
          echo "âœ“ All nomad-pack tests passed"
          echo ""
          echo "Rendered jobs available in artifacts"
