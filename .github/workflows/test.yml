# -------------------------------------------------------------------------------
# Project: Nomad Job Template
# Author: Alex Freidah
# -------------------------------------------------------------------------------
# GitHub Actions workflow to run nomad-pack template tests. Builds Dockerfile
# inline and runs tests in the container on GitHub-hosted runners.
# -------------------------------------------------------------------------------

name: Nomad Pack Tests

on:
  pull_request:
  push:
    branches: [main]
    tags: ['*']

jobs:
  # -----------------------------------------------------------------------
  # Test nomad-pack templates using built container image
  # -----------------------------------------------------------------------
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: false
          load: true
          tags: nomad-pack-builder:test

      - name: Run tests in container
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            nomad-pack-builder:test \
            make test

      - name: Upload rendered jobs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rendered-nomad-jobs
          path: /tmp/nomad-pack-rendered/
          retention-days: 30
          if-no-files-found: ignore

      - name: Test summary
        if: success()
        run: |
          echo "âœ“ All nomad-pack tests passed"
